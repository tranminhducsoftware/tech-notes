## üîÅ Chi·∫øn l∆∞·ª£c Retry K·∫øt N·ªëi Dependency & HealthCheck Ready

### 1. Ki·∫øn th·ª©c c·ªët l√µi

- **HealthCheck readiness (`/readyz`) ch·ªâ n√™n ki·ªÉm tra tr·∫°ng th√°i k·∫øt n·ªëi th·ª±c t·∫ø t·ªõi c√°c service ngo√†i** (DB, Redis, RabbitMQ, external API...).
- **Kh√¥ng restart app/pod** ch·ªâ v√¨ m·∫•t k·∫øt n·ªëi t·∫°m th·ªùi v·ªõi dependency.
- **Liveness (`/healthz`) ch·ªâ ki·ªÉm tra process c√≤n s·ªëng, port m·ªü.**

---

### 2. Best Practice v·ªÅ Retry

#### a. K·∫øt n·ªëi dependency b·∫Øt bu·ªôc (DB, Redis, Message Broker...)

- **Ph·∫£i t·ª± ƒë·ªông retry/reconnect m√£i m√£i khi m·∫•t k·∫øt n·ªëi**.
- **Kh√¥ng throw exception r·ªìi b·ªè cu·ªôc** ‚Äì lu√¥n c√≥ backoff tƒÉng d·∫ßn v√† (n·∫øu c√≥ th·ªÉ) th√™m jitter ƒë·ªÉ tr√°nh b√£o retry ƒë·ªìng lo·∫°t.
- **Kh√¥ng ‚Äúblock‚Äù app startup ch·ªù dependency** ‚Äì c·ª© b·∫≠t app l√™n, retry ng·∫ßm ·ªü background.

#### b. Retry Pattern ph·ªï bi·∫øn

- **Exponential Backoff + Jitter**:

    ```csharp
    var policy = Policy
        .Handle<Exception>()
        .WaitAndRetryForever(
            attempt => TimeSpan.FromSeconds(Math.Pow(2, Math.Min(attempt, 6))) + TimeSpan.FromMilliseconds(Random.Shared.Next(1000))
        );
    ```
    - C·ª© m·ªói l·∫ßn fail th√¨ retry, kho·∫£ng c√°ch retry tƒÉng d·∫ßn, c·ªông th√™m jitter random ƒë·ªÉ tr√°nh nhi·ªÅu pod retry c√πng l√∫c.

#### c. Khi dependency OK tr·ªü l·∫°i

- K·∫øt n·ªëi t·ª± ƒë·ªông h·ªìi ph·ª•c, **readiness check s·∫Ω pass l·∫°i**, pod t·ª± ƒë·ªông nh·∫≠n traffic b√¨nh th∆∞·ªùng, **kh√¥ng c·∫ßn restart pod/app**.

#### d. Monitoring v√† alert

- **C·∫ßn c√≥ c·∫£nh b√°o (monitoring, alerting)** n·∫øu qu√° l√¢u kh√¥ng reconnect ƒë∆∞·ª£c.
- App v·∫´n s·ªëng, readiness fail, pod s·∫Ω t·∫°m r√∫t kh·ªèi load balancer.

---

### 3. G·ª£i √Ω implement trong code

- Khi ƒëƒÉng k√Ω HealthCheck readiness, lu√¥n ki·ªÉm tra tr·∫°ng th√°i *th·∫≠t* c·ªßa k·∫øt n·ªëi ‚Äì KH√îNG cache k·∫øt qu·∫£ c≈©.
- ƒê·∫£m b·∫£o m·ªçi dependency critical ƒë·ªÅu c√≥ retry/reconnect logic ·ªü layer k·∫øt n·ªëi.

---

### 4. Ngu·ªìn tham kh·∫£o

- [Google: Exponential Backoff and Jitter](https://cloud.google.com/storage/docs/exponential-backoff)
- [Microsoft: Retry Guidance](https://learn.microsoft.com/en-us/azure/architecture/best-practices/retry-service-specific)
- [AWS: Best Practices for Resilient Architecture](https://aws.amazon.com/builders-library/timeouts-retries-backoff/)

---

**T√≥m l·∫°i:**  
Lu√¥n t√°ch bi·ªát r√µ liveness & readiness, readiness ch·ªâ ki·ªÉm tra dependency ngo√†i.  
Critical connection c·∫ßn chi·∫øn l∆∞·ª£c retry v√¥ t·∫≠n c√≥ ki·ªÉm so√°t (backoff, jitter), gi√∫p h·ªá th·ªëng v·∫≠n h√†nh ·ªïn ƒë·ªãnh, t·ª± ph·ª•c h·ªìi, cloud-native.
